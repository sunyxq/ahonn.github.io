<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">



  <meta name="description" content="Koa2 源码分析"/>




  <meta name="keywords" content="Ahonn, Ahonn's Blog, 前端，JavaScript，Vim, 编程" />



  <meta name="baidu-site-verification" content="0a275bcf7d954b807e1db498d8e5b192" />



  <meta name="google-site-verification" content="j5dWC85DkoAfUR50W00ewfii3X9ouH55HnyBP6oZxGE" />






  <link rel="alternate" href="/atom.xml" title="Ahonn">




  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=2.5.0" />



<link rel="canonical" href="http://www.ahonn.me/2017/05/17/koa2-analysis/"/>


<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.5.0" />






  
  <script id="baidu_analytics">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0a275bcf7d954b807e1db498d8e5b192";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  <script id="google_analytics">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-74273646-1', 'auto');
        ga('send', 'pageview');
  </script>


  <script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>



    <title> Koa2 源码分析 - Ahonn </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Ahonn</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            Home
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            Archives
          
        </li>
      </a>
    
      <a href="/about">
        <li class="mobile-menu-item">
          
          
            About
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Ahonn</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              首页
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              归档
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/about">
            
            
              关于
            
          </a>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          Koa2 源码分析
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-05-17
        </span>
        
          <div class="post-category">
            
              <a href="/categories/thinking/">思考总结</a>
            
          </div>
        
      </div>
    </header>

    
    
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#源码结构"><span class="toc-text">源码结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Application"><span class="toc-text">Application</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#构造函数"><span class="toc-text">构造函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Application-listen"><span class="toc-text">Application#listen</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Application-use"><span class="toc-text">Application#use</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Application-callback"><span class="toc-text">Application#callback</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#handleRequest"><span class="toc-text">handleRequest</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#createContext"><span class="toc-text">createContext</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#respond"><span class="toc-text">respond</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Compose"><span class="toc-text">Compose</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Context"><span class="toc-text">Context</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Context-onerror"><span class="toc-text">Context#onerror</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Request"><span class="toc-text">Request</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Response"><span class="toc-text">Response</span></a></li></ol>
    </div>
  </div>


    <div class="post-content">
      
        <h2 id="源码结构"><a href="#源码结构" class="headerlink" title="源码结构"></a>源码结构</h2><p>Koa 的源码中主要为 <code>lib</code> 目录下的 <code>application.js</code>、<code>context.js</code>、<code>request.js</code> 与 <code>response.js</code> 文件</p>
<a id="more"></a>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">.</div><div class="line">├── AUTHORS</div><div class="line">├── CODE_OF_CONDUCT.md</div><div class="line">├── History.md</div><div class="line">├── LICENSE</div><div class="line">├── Makefile</div><div class="line">├── Readme.md</div><div class="line">├── benchmarks</div><div class="line">├── docs</div><div class="line">├── lib</div><div class="line">│   ├── application.js</div><div class="line">│   ├── context.js</div><div class="line">│   ├── request.js</div><div class="line">│   └── response.js</div><div class="line">├── package.json</div><div class="line">└── test</div></pre></td></tr></table></figure>
<p><strong>application.js</strong>: 框架入口，导出 Application 类，即使用时导入的 Koa 类</p>
<p><strong>context.js</strong>: context 对象的原型，代理 request 与 response 对象</p>
<p><strong>request.js</strong>:  request 对象的原型，提供请求相关的数据与操作</p>
<p><strong>response.js</strong>: response 对象的原型，提供响应相关的数据与操作</p>
<h2 id="Application"><a href="#Application" class="headerlink" title="Application"></a>Application</h2><p>application.js 是 Koa 框架的入口，导出 Application 类来用于创建 app 对象。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>); <span class="comment">// 导入 Koa, 即导入 Application 类</span></div><div class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa(); <span class="comment">// 创建 Application 类的实例</span></div></pre></td></tr></table></figure>
<p>Application 继承于 EventEmitter 类，使得 Koa 能够监听事件。</p>
<h2 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h2><p>Application 类包含了以下属性：</p>
<ul>
<li><strong>proxy</strong>: 是否信任 proxy header 参数，默认为 false</li>
<li><strong>middleware</strong>: 保存通过 <code>app.use(middleware)</code> 注册的中间件</li>
<li><strong>subdomainOffset</strong>: 子域默认偏移量，默认为 2</li>
<li><strong>env</strong>: 环境参数，默认为 NODE_ENV 或 ‘development’</li>
<li><strong>context</strong>: context 模块，通过 <code>context.js</code> 创建</li>
<li><strong>request</strong>: request 模块，通过 <code>request.js</code> 创建</li>
<li><strong>response</strong>: response 模块，通过 <code>response.js</code> 创建 </li>
</ul>
<h2 id="Application-listen"><a href="#Application-listen" class="headerlink" title="Application#listen"></a>Application#listen</h2><p>Koa 通过 <code>app.listen(port)</code> 函数在某个端口启动服务。</p>
<p>listen 函数通过 http 模块开启服务：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Shorthand for:</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *    http.createServer(app.callback()).listen(...)</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param &#123;Mixed&#125; ...</span></div><div class="line"><span class="comment"> * @return &#123;Server&#125;</span></div><div class="line"><span class="comment"> * @api public</span></div><div class="line"><span class="comment"> */</span></div><div class="line"></div><div class="line">listen(...args) &#123;</div><div class="line">  debug(<span class="string">'listen'</span>);</div><div class="line">  <span class="keyword">const</span> server = http.createServer(<span class="keyword">this</span>.callback());</div><div class="line">  <span class="keyword">return</span> server.listen(...args);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>实际上 <code>app.listen()</code>为 <code>http.createServer(app.callback()).listen(...)</code>的速记写法。</p>
<p><code>http.createServer()</code>用于创建 Web 服务器，接受一个请求监听函数，并在得到请求时执行。</p>
<p><code>app.callback()</code>用于处理请求，合并中间件与创建请求上下文对象等。</p>
<h3 id="Application-use"><a href="#Application-use" class="headerlink" title="Application#use"></a>Application#use</h3><p>Koa 通过 <code>app.use()</code>添加中间件，并将中间件储存在 <code>app.middleware</code>中。</p>
<p>在执行 <code>app.callback()</code>时会将 <code>app.middleware</code> 中的中间件合并为一个函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Use the given middleware `fn`.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Old-style middleware will be converted.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param &#123;Function&#125; fn</span></div><div class="line"><span class="comment"> * @return &#123;Application&#125; self</span></div><div class="line"><span class="comment"> * @api public</span></div><div class="line"><span class="comment"> */</span></div><div class="line"></div><div class="line">use(fn) &#123;</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> fn !== <span class="string">'function'</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'middleware must be a function!'</span>);</div><div class="line">  <span class="keyword">if</span> (isGeneratorFunction(fn)) &#123;</div><div class="line">    deprecate(<span class="string">'Support for generators will be removed in v3. '</span> +</div><div class="line">              <span class="string">'See the documentation for examples of how to convert old middleware '</span> +</div><div class="line">              <span class="string">'https://github.com/koajs/koa/blob/master/docs/migration.md'</span>);</div><div class="line">    fn = convert(fn);</div><div class="line">  &#125;</div><div class="line">  debug(<span class="string">'use %s'</span>, fn._name || fn.name || <span class="string">'-'</span>);</div><div class="line">  <span class="keyword">this</span>.middleware.push(fn);</div><div class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Koa1.x 版本使用 Generator Function 的方式写中间件，而 Koa2 改用 ES6 async/await。</p>
<p>所以在 <code>use()</code> 函数中会判断是否为旧风格的中间件写法，并对旧风格写法的中间件进行转换（使用 <a href="https://github.com/koajs/convert" target="_blank" rel="external">koa-convert</a> 进行转换）。</p>
<p>可以注意到这里 <code>use()</code> 函数返回了 this，这使得在添加中间件的时候能够链式调用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">app</div><div class="line">  .use(<span class="function"><span class="keyword">function</span> (<span class="params">ctx, next</span>) </span>&#123;</div><div class="line">    <span class="comment">// do some thing</span></div><div class="line">  &#125;)</div><div class="line">  .use(<span class="function"><span class="keyword">function</span> (<span class="params">ctx, next</span>) </span>&#123;</div><div class="line">    <span class="comment">// do some thing</span></div><div class="line">  &#125;)</div><div class="line">  <span class="comment">// ...</span></div></pre></td></tr></table></figure>
<h3 id="Application-callback"><a href="#Application-callback" class="headerlink" title="Application#callback"></a>Application#callback</h3><p><code>app.callback()</code>负责合并中间件，创建请求上下文对象以及返回请求处理函数等。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Return a request handler callback</span></div><div class="line"><span class="comment"> * for node's native http server.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @return &#123;Function&#125;</span></div><div class="line"><span class="comment"> * @api public</span></div><div class="line"><span class="comment"> */</span></div><div class="line"></div><div class="line">callback() &#123;</div><div class="line">  <span class="keyword">const</span> fn = compose(<span class="keyword">this</span>.middleware);</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (!<span class="keyword">this</span>.listeners(<span class="string">'error'</span>).length) <span class="keyword">this</span>.on(<span class="string">'error'</span>, <span class="keyword">this</span>.onerror);</div><div class="line"></div><div class="line">  <span class="keyword">const</span> handleRequest = <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</div><div class="line">    res.statusCode = <span class="number">404</span>;</div><div class="line">    <span class="keyword">const</span> ctx = <span class="keyword">this</span>.createContext(req, res);</div><div class="line">    <span class="keyword">const</span> onerror = <span class="function"><span class="params">err</span> =&gt;</span> ctx.onerror(err);</div><div class="line">    <span class="keyword">const</span> handleResponse = <span class="function"><span class="params">()</span> =&gt;</span> respond(ctx);</div><div class="line">    onFinished(res, onerror);</div><div class="line">    <span class="keyword">return</span> fn(ctx).then(handleResponse).catch(onerror);</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> handleRequest;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过 <code>compose</code> 函数（<a href="https://github.com/koajs/compose" target="_blank" rel="external">koa-compose</a>）合并 <code>app.middleware</code>中的所有中间件。<a href="/koa/compose.md">查看</a>关于 koa-compose 的分析。</p>
<p><code>app.callback()</code> 函数最后返回一个请求处理函数 <code>handleRequest</code>。该函数即为<code>http.createServer</code> 接收的请求处理函数，在得到请求时执行。</p>
<h4 id="handleRequest"><a href="#handleRequest" class="headerlink" title="handleRequest"></a>handleRequest</h4><p><code>handleRequest</code>函数首先将响应状态码默认设置为 404，接着通过 <code>app.createContext()</code>创建请求的上下文对象。</p>
<p><code>onFinished(res, onerror)</code>通过第三方库 <a href="https://github.com/jshttp/on-finished" target="_blank" rel="external">on-finished</a> 监听 http response，当请求结束时执行回调。</p>
<p>这里传入的回调是 <code>context.onerror(err)</code>，即当错误发生时才执行。</p>
<p>最后返回 <code>fn(ctx).then(handleResponse).catch(onerror)</code>，即将所有中间件执行（传入请求上下文对象 ctx），之后执行响应处理函数（<code>app.respond(ctx)</code>），当抛出异常时同样使用 <code>cintext.onerror(err)</code>处理。</p>
<h4 id="createContext"><a href="#createContext" class="headerlink" title="createContext"></a>createContext</h4><p>app.createContext() 用来创建请求上下文对象，并代理 Koa 的 request 和 response 模块。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Initialize a new context.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @api private</span></div><div class="line"><span class="comment"> */</span></div><div class="line"></div><div class="line">createContext(req, res) &#123;</div><div class="line">  <span class="keyword">const</span> context = <span class="built_in">Object</span>.create(<span class="keyword">this</span>.context);</div><div class="line">  <span class="keyword">const</span> request = context.request = <span class="built_in">Object</span>.create(<span class="keyword">this</span>.request);</div><div class="line">  <span class="keyword">const</span> response = context.response = <span class="built_in">Object</span>.create(<span class="keyword">this</span>.response);</div><div class="line">  context.app = request.app = response.app = <span class="keyword">this</span>;</div><div class="line">  context.req = request.req = response.req = req;</div><div class="line">  context.res = request.res = response.res = res;</div><div class="line">  request.ctx = response.ctx = context;</div><div class="line">  request.response = response;</div><div class="line">  response.request = request;</div><div class="line">  context.originalUrl = request.originalUrl = req.url;</div><div class="line">  context.cookies = <span class="keyword">new</span> Cookies(req, res, &#123;</div><div class="line">    keys: <span class="keyword">this</span>.keys,</div><div class="line">    secure: request.secure</div><div class="line">  &#125;);</div><div class="line">  request.ip = request.ips[<span class="number">0</span>] || req.socket.remoteAddress || <span class="string">''</span>;</div><div class="line">  context.accept = request.accept = accepts(req);</div><div class="line">  context.state = &#123;&#125;;</div><div class="line">  <span class="keyword">return</span> context;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里对请求都对应在上下文对象中添加对应的 cookies。</p>
<h4 id="respond"><a href="#respond" class="headerlink" title="respond"></a>respond</h4><p><code>app.respond(ctx)</code> 函数，也就是 <code>app.createContext()</code>函数中的 <code>handleResponse</code>。在所有中间件执行完之后执行。</p>
<p>在 koa 中可以通过设置 <code>ctx.respond = false</code>来跳过这个函数，但不推荐这样做。另外，当上下文对象不可写时也会退出该函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (<span class="literal">false</span> === ctx.respond) <span class="keyword">return</span>;</div><div class="line"><span class="comment">// ...</span></div><div class="line"><span class="keyword">if</span> (!ctx.writable) <span class="keyword">return</span>;</div></pre></td></tr></table></figure>
<p>当返回的状态码表示没有响应主体时，将响应主体置空：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ignore body</span></div><div class="line"><span class="keyword">if</span> (statuses.empty[code]) &#123;</div><div class="line">  <span class="comment">// strip headers</span></div><div class="line">  ctx.body = <span class="literal">null</span>;</div><div class="line">  <span class="keyword">return</span> res.end();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当请求方法为 HEAD 时，判断响应头是否发送以及响应主体是否为 JSON 格式，若满足则设置响应 Content-Length：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (<span class="string">'HEAD'</span> == ctx.method) &#123;</div><div class="line">  <span class="keyword">if</span> (!res.headersSent &amp;&amp; isJSON(body)) &#123;</div><div class="line">    ctx.length = Buffer.byteLength(<span class="built_in">JSON</span>.stringify(body));</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> res.end();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当返回的状态码表示有响应主体，但响应主体为空时，将响应主体设置为响应信息或状态码。并当响应头未发送时设置 Content-Type 与 Content-Length：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (<span class="literal">null</span> == body) &#123;</div><div class="line">  body = ctx.message || <span class="built_in">String</span>(code);</div><div class="line">  <span class="keyword">if</span> (!res.headersSent) &#123;</div><div class="line">    ctx.type = <span class="string">'text'</span>;</div><div class="line">    ctx.length = Buffer.byteLength(body);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> res.end(body);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后，对不同的响应主体进行处理：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// responses</span></div><div class="line"><span class="keyword">if</span> (Buffer.isBuffer(body)) <span class="keyword">return</span> res.end(body);</div><div class="line"><span class="keyword">if</span> (<span class="string">'string'</span> == <span class="keyword">typeof</span> body) <span class="keyword">return</span> res.end(body);</div><div class="line"><span class="keyword">if</span> (body <span class="keyword">instanceof</span> Stream) <span class="keyword">return</span> body.pipe(res);</div><div class="line"></div><div class="line"><span class="comment">// body: json</span></div><div class="line">body = <span class="built_in">JSON</span>.stringify(body);</div><div class="line"><span class="keyword">if</span> (!res.headersSent) &#123;</div><div class="line">  ctx.length = Buffer.byteLength(body);</div><div class="line">&#125;</div><div class="line">res.end(body);</div></pre></td></tr></table></figure>
<h2 id="Compose"><a href="#Compose" class="headerlink" title="Compose"></a>Compose</h2><p>在 application.js 中，<code>callback()</code>函数通过 <code>koa-compose</code> 组合所有的中间件，组合成单个函数。</p>
<p>koa-compose  的实现很简单：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">compose</span> (<span class="params">middleware</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(middleware)) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'Middleware stack must be an array!'</span>)</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> fn <span class="keyword">of</span> middleware) &#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> fn !== <span class="string">'function'</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'Middleware must be composed of functions!'</span>)</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">context, next</span>) </span>&#123;</div><div class="line">    <span class="comment">// last called middleware #</span></div><div class="line">    <span class="keyword">let</span> index = <span class="number">-1</span></div><div class="line">    <span class="keyword">return</span> dispatch(<span class="number">0</span>)</div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span> (<span class="params">i</span>) </span>&#123;</div><div class="line">      <span class="keyword">if</span> (i &lt;= index) <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'next() called multiple times'</span>))</div><div class="line">      index = i</div><div class="line">      <span class="keyword">let</span> fn = middleware[i]</div><div class="line">      <span class="keyword">if</span> (i === middleware.length) fn = next</div><div class="line">      <span class="keyword">if</span> (!fn) <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve()</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(fn(context, <span class="function"><span class="keyword">function</span> <span class="title">next</span> (<span class="params"></span>) </span>&#123;</div><div class="line">          <span class="keyword">return</span> dispatch(i + <span class="number">1</span>)</div><div class="line">        &#125;))</div><div class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(err)</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>首先判断了传入得中间件参数是否为数组，并检查且数组的元素是否为函数，然后返回了一个将中间件组合起来的函数。</p>
<p>重点关注返回的函数中的<code>dispatch(i)</code>函数，这个函数将获取第一个中间件，并在返回的 Promise 中执行。当中间件<code>await next()</code>时执行下一个中间件，即 <code>dispatch(i + 1)</code>。</p>
<p>执行流程可以简单看作：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">middleware1</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'middleware1 begin'</span>);</div><div class="line">    <span class="keyword">await</span> middleware2();</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'middleware1 end'</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">middleware2</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'middleware2 begin'</span>);</div><div class="line">    <span class="keyword">await</span> middleware3();</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'middleware2 end'</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">middleware3</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'middleware3 begin'</span>);</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'middleware3 end'</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line">middleware1();</div><div class="line"><span class="comment">// 执行结果</span></div><div class="line">middleware1 begin</div><div class="line">middleware2 begin</div><div class="line">middleware3 begin</div><div class="line">middleware3 end</div><div class="line">middleware2 end</div><div class="line">middleware1 end</div></pre></td></tr></table></figure>
<p><code>compose()</code> 函数通过 Promise 将这个过程串联起来，从而返回单个中间件函数。</p>
<h2 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h2><p>Koa 中的 Context 模块封装了 request 与 response，代理了这两个对象的方法与属性。</p>
<p>其中使用了 Tj 写的 <a href="https://github.com/tj/node-delegates" target="_blank" rel="external">node-delegates</a> 库，用于代理 context.request 与 context.response 上的方法与属性。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Response delegation.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"></div><div class="line">delegate(proto, <span class="string">'response'</span>)</div><div class="line">  .method(<span class="string">'attachment'</span>)</div><div class="line">  .method(<span class="string">'redirect'</span>)</div><div class="line">  .method(<span class="string">'remove'</span>)</div><div class="line">  .method(<span class="string">'vary'</span>)</div><div class="line">  .method(<span class="string">'set'</span>)</div><div class="line">  .method(<span class="string">'append'</span>)</div><div class="line">  .method(<span class="string">'flushHeaders'</span>)</div><div class="line">  .access(<span class="string">'status'</span>)</div><div class="line">  .access(<span class="string">'message'</span>)</div><div class="line">  .access(<span class="string">'body'</span>)</div><div class="line">  .access(<span class="string">'length'</span>)</div><div class="line">  .access(<span class="string">'type'</span>)</div><div class="line">  .access(<span class="string">'lastModified'</span>)</div><div class="line">  .access(<span class="string">'etag'</span>)</div><div class="line">  .getter(<span class="string">'headerSent'</span>)</div><div class="line">  .getter(<span class="string">'writable'</span>);</div><div class="line">  <span class="comment">// ...</span></div></pre></td></tr></table></figure>
<p>context 除了代理这两个模块之外，还包含了一个请求异常时的错误处理函数。</p>
<p>在 application.js 的 <code>callback()</code>使用到这个函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> onerror = <span class="function"><span class="params">err</span> =&gt;</span> ctx.onerror(err);</div><div class="line"><span class="keyword">const</span> handleResponse = <span class="function"><span class="params">()</span> =&gt;</span> respond(ctx);</div><div class="line">onFinished(res, onerror);</div><div class="line"><span class="keyword">return</span> fn(ctx).then(handleResponse).catch(onerror);</div></pre></td></tr></table></figure>
<h3 id="Context-onerror"><a href="#Context-onerror" class="headerlink" title="Context#onerror"></a>Context#onerror</h3><p><code>context.onerror(err)</code>首先对传入的 err 变量进行判断，当 err 为空时退出该函数，或者当 err 不为空且不为 Error 类型时抛出异常。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (<span class="literal">null</span> == err) <span class="keyword">return</span>;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (!(err <span class="keyword">instanceof</span> <span class="built_in">Error</span>)) err = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`non-error thrown: <span class="subst">$&#123;err&#125;</span>`</span>);</div></pre></td></tr></table></figure>
<p>接着触发 app 自身的 error 事件，将错误抛给 app。</p>
<p>在此之前，设置 <code>headerSent</code>变量表示响应头是否发送，若响应头以发送，或者不可写（即无法在响应中添加错误信息等），则退出该函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> headerSent = <span class="literal">false</span>;</div><div class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.headerSent || !<span class="keyword">this</span>.writable) &#123;</div><div class="line">  headerSent = err.headerSent = <span class="literal">true</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// delegate</span></div><div class="line"><span class="keyword">this</span>.app.emit(<span class="string">'error'</span>, err, <span class="keyword">this</span>);</div><div class="line"></div><div class="line"><span class="comment">// nothing we can do here other</span></div><div class="line"><span class="comment">// than delegate to the app-level</span></div><div class="line"><span class="comment">// handler and log.</span></div><div class="line"><span class="keyword">if</span> (headerSent) &#123;</div><div class="line">   <span class="keyword">return</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>因为发生了错误，所以必须将之前的中间设置的响应头信息清空。</p>
<p>这里使用了 Node 提供的 <a href="https://nodejs.org/api/http.html#http_class_http_serverresponse" target="_blank" rel="external">http.ServerResponse</a> 类上的 <code>getHeaderNames()</code> 与 <code>removeHeader()</code> 方法。但<code>getHeaderNames()</code></p>
<p>这个函数是在 Node.js 7.7 时加入的，所以当没有提供该方法时需要使用 <code>_header</code>来清空响应头。详情可见: <a href="https://github.com/nodejs/node/pull/10805" target="_blank" rel="external">Node.js #10805。</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// first unset all headers</span></div><div class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> res.getHeaderNames === <span class="string">'function'</span>) &#123;</div><div class="line">  res.getHeaderNames().forEach(<span class="function"><span class="params">name</span> =&gt;</span> res.removeHeader(name));</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">  res._headers = &#123;&#125;; <span class="comment">// Node &lt; 7.7</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>清空之前的中间件设置的响应头之后，将响应头设置为 <code>err.headers</code>，并设置 Context-Type 与状态码。</p>
<p>当错误码为 ENOENT 时，意味着找不到该资源，将状态码设置为 404；当没有状态码或状体啊码错误时默认设置为 500。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// then set those specified</span></div><div class="line"><span class="keyword">this</span>.set(err.headers);</div><div class="line"></div><div class="line"><span class="comment">// force text/plain</span></div><div class="line"><span class="keyword">this</span>.type = <span class="string">'text'</span>;</div><div class="line"></div><div class="line"><span class="comment">// ENOENT support</span></div><div class="line"><span class="keyword">if</span> (<span class="string">'ENOENT'</span> == err.code) err.status = <span class="number">404</span>;</div><div class="line"></div><div class="line"><span class="comment">// default to 500</span></div><div class="line"><span class="keyword">if</span> (<span class="string">'number'</span> != <span class="keyword">typeof</span> err.status || !statuses[err.status]) err.status = <span class="number">500</span>;</div></pre></td></tr></table></figure>
<p>最后当抛出的错误为自定义错误时，返回错误信息。</p>
<p>Koa 使用 <a href="https://github.com/jshttp/http-errors" target="_blank" rel="external">http-errors</a> 创建错误对象，<code>expose</code> 属性表示是否像客户端暴露错误信息。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> code = statuses[err.status];</div><div class="line"><span class="keyword">const</span> msg = err.expose ? err.message : code;</div><div class="line"><span class="keyword">this</span>.status = err.status;</div><div class="line"><span class="keyword">this</span>.length = Buffer.byteLength(msg);</div><div class="line"><span class="keyword">this</span>.res.end(msg);</div></pre></td></tr></table></figure>
<h2 id="Request"><a href="#Request" class="headerlink" title="Request"></a>Request</h2><p>Request 模块封装了请求相关的属性以及方法。通过 application 中的 <code>createContext()</code> 方法，代理对应的 request 对象。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> request = context.request = <span class="built_in">Object</span>.create(<span class="keyword">this</span>.request);</div><div class="line"><span class="comment">// ...</span></div><div class="line">context.req = request.req = response.req = req;</div><div class="line"><span class="comment">// ...</span></div><div class="line">request.response = response;</div></pre></td></tr></table></figure>
<p><code>request.req</code>为原生的请求对象，在 Request 模块中属性的获取都是通过 <code>ths.req</code> 来获取的（即 <code>request.req</code>）。</p>
<h2 id="Response"><a href="#Response" class="headerlink" title="Response"></a>Response</h2><p>Response 模块封装了响应相关的属性以及方法。与 request 相同，通过<code>createContext()</code> 方法代理对应的 response 对象。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> response = context.response = <span class="built_in">Object</span>.create(<span class="keyword">this</span>.response);</div><div class="line"><span class="comment">// ...</span></div><div class="line">context.res = request.res = response.res = res;</div><div class="line"><span class="comment">// ...</span></div><div class="line">response.request = request;</div></pre></td></tr></table></figure>

      
    </div>

    
      
      



      
      
    

    
      <footer class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/Koa/">Koa</a>
            
              <a href="/tags/Node-js/">Node.js</a>
            
          </div>
        
        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2017/06/08/write-a-react-from-scratch-init-render/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">从零开始写一个 React：初始化渲染</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    
    
      <a class="next" href="/2017/03/27/use-neovim/">
        <span class="next-text nav-default">转投 Neovim</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

      </footer>
    

  </article>


          </div>
          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>  
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:ahonn95@outlook.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/ahonn" class="iconfont icon-github" title="github"></a>
        
      
    
      
    
      
        
          <a href="https://www.zhihu.com/people/ahonn/activities" class="iconfont icon-zhihu" title="zhihu"></a>
        
      
    
      
    
      
    
      
    
    
    
      <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    
  </div>


<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2015 - 
    
    2017

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Ahonn</span>
  </span>
</div>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  
  <script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'http://www.ahonn.me/2017/05/17/koa2-analysis/';
        this.page.identifier = '2017/05/17/koa2-analysis/';
        this.page.title = 'Koa2 源码分析';
    };
    (function() {
    var d = document, s = d.createElement('script');

    s.src = '//ahonn.disqus.com/embed.js';

    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();  
  </script>




    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  


    <script type="text/javascript" src="/js/src/even.js?v=2.5.0"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=2.5.0"></script>

  </body>
</html>
