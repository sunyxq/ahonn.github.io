<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">



  <meta name="description" content="从零开始写一个 React：初始化渲染"/>




  <meta name="keywords" content="Ahonn, Ahonn's Blog, 前端，JavaScript，Vim, 编程" />



  <meta name="baidu-site-verification" content="0a275bcf7d954b807e1db498d8e5b192" />



  <meta name="google-site-verification" content="j5dWC85DkoAfUR50W00ewfii3X9ouH55HnyBP6oZxGE" />






  <link rel="alternate" href="/atom.xml" title="Ahonn">




  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=2.6.0" />



<link rel="canonical" href="http://www.ahonn.me/2017/06/08/write-a-react-from-scratch-init-render/"/>


<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.6.0" />






  
  <script id="baidu_analytics">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0a275bcf7d954b807e1db498d8e5b192";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  <script id="google_analytics">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-74273646-1', 'auto');
        ga('send', 'pageview');
  </script>


  <script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>





  <script src="//cdn1.lncld.net/static/js/3.1.1/av-min.js"></script>
  <script id="leancloud">
    AV.init({
      appId: "yQb0X4LzhGQewvhzfS4Pwbbe-gzGzoHsz",
      appKey: "7r9WpoHmf3Q2YwE8IKjEfY7w"
    });
  </script>





    <title> 从零开始写一个 React：初始化渲染 - Ahonn </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Ahonn</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            首页
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            归档
          
        </li>
      </a>
    
      <a href="/about">
        <li class="mobile-menu-item">
          
          
            关于
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Ahonn</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              首页
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              归档
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/about">
            
            
              关于
            
          </a>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          从零开始写一个 React：初始化渲染
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-06-08
        </span>
        
          <div class="post-category">
            
              <a href="/categories/thinking/">思考总结</a>
            
          </div>
        
        
        <div class="post-visits"
             data-url="/2017/06/08/write-a-react-from-scratch-init-render/"
             data-title="从零开始写一个 React：初始化渲染">
            阅读次数
          </div>
        
      </div>
    </header>

    
    
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#源码解析：渲染过程"><span class="toc-text">源码解析：渲染过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#JSX-解析"><span class="toc-text">JSX 解析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#渲染到页面"><span class="toc-text">渲染到页面</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#生成-ReactComponent"><span class="toc-text">生成 ReactComponent</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#从零开始：实现初始化渲染"><span class="toc-text">从零开始：实现初始化渲染</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#设置-babel"><span class="toc-text">设置 babel</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实现-createElement"><span class="toc-text">实现 createElement</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实现工厂方法-instantiateReactComponent"><span class="toc-text">实现工厂方法 instantiateReactComponent</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实现-ReactComponent"><span class="toc-text">实现 ReactComponent</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实现-render"><span class="toc-text">实现 render</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#后记"><span class="toc-text">后记</span></a></li></ol>
    </div>
  </div>


    <div class="post-content">
      
        <p>『从零开始写一个 React』 将会是一个小系列，记录学习 React 源码的过程，并逐步实现一个简易的类 React 库。</p>
<p>这是本系列的第一篇文章，该文章将阅读 React 初始化渲染相关的代码，并实现一个简单的将 JSX 渲染到页面的功能。（不包括组件生命周期与事件处理相关部分）</p>
<a id="more"></a>
<h2 id="源码解析：渲染过程"><a href="#源码解析：渲染过程" class="headerlink" title="源码解析：渲染过程"></a>源码解析：渲染过程</h2><h3 id="JSX-解析"><a href="#JSX-解析" class="headerlink" title="JSX 解析"></a>JSX 解析</h3><p>我们知道在 React 组件<code>render()</code> 返回的是 JSX，而 JSX 将会被 babel 转换。JSX 将被转换为 <code>React.createElement(type, config, children)</code>的形式。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// App.js</span></div><div class="line"><span class="comment">// 转换前</span></div><div class="line">Class App extends Component &#123;</div><div class="line">    render() &#123;</div><div class="line">        <span class="keyword">return</span> &lt;h1 id='title'&gt;Hello World&lt;h1&gt;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">// 转换后</div><div class="line">var App = React.createClass(&#123;</div><div class="line">    render() &#123;</div><div class="line">        return React.createElement('h1', &#123;</div><div class="line">            id: 'title'</div><div class="line">        &#125;, 'hello world')</div><div class="line">    &#125;</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p><code>React.createElement()</code> 的实现位于 <a href="https://github.com/facebook/react/blob/15-stable/src/isomorphic/classic/element/ReactElement.js#L183" target="_blank" rel="noopener">/src/isomorphic/classic/element/ReactElement.js</a></p>
<p>这里的 <code>React.createElement()</code>是用来生成虚拟 DOM 元素，该函数对组件的属性，事件，子组件等进行了处理，并返回值为一个 <code>ReactElement</code> 对象（单纯的 JavaScript 对象，仅包括 type, props, key, ref 等属性）。</p>
<p>这恰好说明了 JSX 中的 <code>&lt;h1 id=&#39;title&#39;&gt;hello world&lt;/h1&gt;</code>实际上是 JavaScript 对象，而不是我们通常写的 HTML 标签。</p>
<h3 id="渲染到页面"><a href="#渲染到页面" class="headerlink" title="渲染到页面"></a>渲染到页面</h3><p>单单声明了组件而没有渲染到页面上我们是看不见的（废话），所以我们需要使用 <code>ReactDOM.render()</code>将其渲染到页面指定位置上。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">// index.html</div><div class="line">&lt;html&gt;</div><div class="line">    // ...</div><div class="line">    &lt;body&gt;</div><div class="line">        &lt;div id='root'&gt;&lt;/div&gt;</div><div class="line">    &lt;/body&gt;</div><div class="line">&lt;/html&gt;</div><div class="line"></div><div class="line"></div><div class="line">// index.js</div><div class="line">import React from 'react'</div><div class="line">import ReactDOM from 'react-dom'</div><div class="line">import App from './App.js'</div><div class="line"></div><div class="line">ReactDOM.render(&lt;App /&gt;, document.getElementById('root'))</div></pre></td></tr></table></figure>
<p><code>ReactDOM.render()</code> 的实现位于<a href="https://github.com/facebook/react/blob/master/src/renderers/dom/stack/client/ReactMount.js#L581" target="_blank" rel="noopener"> </a><a href="https://github.com/facebook/react/blob/15-stable/src/renderers/dom/client/ReactMount.js" target="_blank" rel="noopener">/src/renderers/dom/client/ReactMount.js</a></p>
<p><code>ReactDOM.render()</code> 函数将会根据 <code>ReactElement</code> 的类型生成相对应的<code>ReactComponent</code> 实例，并调用其 <code>mountComponent()</code>函数进行组件加载（返回 HTML片段），递归加载所有组件后，通过 <a href="https://github.com/facebook/react/blob/b1768b5a48d1f82e4ef4150e0036c5f846d3758a/src/renderers/dom/shared/setInnerHTML.js" target="_blank" rel="noopener">setInnerHTML</a> 将 HTML 渲染到页面上。</p>
<p>判断需要生成那种 <code>ReactComponent</code>实例根据 <code>ReactElement</code> 对象的 type 属性来决定。对应 HTML 标签的 type 一般为字符串，而自定义的组件则是大写字母开头的组件函数（自定义组件需要 import，而 HTML 标签不需要）。</p>
<h4 id="生成-ReactComponent"><a href="#生成-ReactComponent" class="headerlink" title="生成 ReactComponent"></a>生成 <strong>ReactComponent</strong></h4><p>React 中生成对应的 <code>ReactComponent</code>实例由 <code>instantiateReactComponent()</code>完成，其实现位于 <a href="https://github.com/facebook/react/blob/15-stable/src/renderers/shared/stack/reconciler/instantiateReactComponent.js" target="_blank" rel="noopener">/src/renderers/shared/stack/reconciler/instantiateReactComponent.js</a></p>
<p><code>ReactComponent</code> 分为 3 种：</p>
<ul>
<li><p><code>ReactEmptyComponent</code>:  空组件（ReactElement 的 type 属性为 null 或 false 的组件），在浏览器中返回 <code>ReactDOMEmptyComponent</code>。</p>
</li>
<li><p><code>ReactHostComponent</code>: 原生组件（ReactElement 为string，number 或 ReactElement 的 type 属性为 string 的组件）。</p>
<ul>
<li><p><code>createInternalComponent()</code>：该函数用于创建原生组件，在浏览器中返回 <code>ReactDOMComponent</code>。</p>
</li>
<li><p><code>createInstanceForText()</code> : 该函数用于创建纯文本组件，在浏览器中返回 <code>ReactDOMTextComponent</code>。</p>
</li>
</ul>
</li>
<li><p><code>ReactCompositeComponent</code>: 自定义组件（ReactElement 的 type 属性为 function）</p>
</li>
</ul>
<p>可以发现 React 与平台解耦，使用 <code>ReactEmptyComponent</code> 与 <code>ReactHostComponent</code>。而这两种组件会根据平台的不同生成不同的组件对象，在浏览器中则为 <code>ReactDOMEmptyComponent</code>、<code>ReactDOMComponent</code> 与 <code>ReactDOMTextComponent</code>。</p>
<p>它们通过 <a href="https://github.com/facebook/react/blob/15-stable/src/renderers/dom/stack/client/ReactDOMStackInjection.js" target="_blank" rel="noopener">/src/renderers/dom/stack/client/ReactDOMStackInjection.js</a> 进行注入。</p>
<p>（ <a href="https://github.com/facebook/react/tree/15-stable/src/renderers" target="_blank" rel="noopener">/src/renderers </a>路径下包含各个平台上不同的 ReactComponent 实现，包括 react-art/react-dom/react-native。）</p>
<h2 id="从零开始：实现初始化渲染"><a href="#从零开始：实现初始化渲染" class="headerlink" title="从零开始：实现初始化渲染"></a>从零开始：实现初始化渲染</h2><h3 id="设置-babel"><a href="#设置-babel" class="headerlink" title="设置 babel"></a>设置 babel</h3><p>首先我们需要了解 babel 如何转换 JSX：<a href="https://babeljs.io/docs/plugins/transform-react-jsx/" target="_blank" rel="noopener">React JSX transform</a>。</p>
<p>babel 可以通过<code>transform-react-jsx</code>插件来设置解析 JSX 之后调用的函数，默认解析为调用 <code>React.createElement()</code>。所以这就是为什么虽然在 JSX 代码中没有使用到 React，却仍然需要导入它。</p>
<p>通过配置 <code>transform-react-jsx</code>插件的 <code>pragma</code>选项可以修改解析后调用的函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 修改解析为调用 dom() 函数</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"plugins"</span>: [</div><div class="line">    [<span class="string">"transform-react-jsx"</span>, &#123;</div><div class="line">      <span class="string">"pragma"</span>: <span class="string">"dom"</span> <span class="comment">// 默认 pragma 为 React.createElement</span></div><div class="line">    &#125;]</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>babel 将会把 JSX 中的标签名作为第一个参数，把 JSX 中的标签属性作为第二个参数，将标签内容作为剩余的参数。传递这些参数给 <code>pragma</code> 选项设置的函数。</p>
<p><strong>PS: 为了方便起见，我们使用默认的解析为 React.createElement()</strong></p>
<h3 id="实现-createElement"><a href="#实现-createElement" class="headerlink" title="实现 createElement"></a>实现 createElement</h3><p><code>createElement()</code>接受至少 2 个参数：元素类型 type（字符串表示原生元素，函数表示自定义元素），元素设置 config。其他参数视为元素的子元素 children。并且该函数返回的是一个 <code>ReactElement</code> 对象，属性包括 type, props, key, ref。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// element.js</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReactElement</span> </span>&#123;</div><div class="line">    <span class="keyword">constructor</span>(type, props, key, ref) &#123;</div><div class="line">        <span class="keyword">this</span>.type = type</div><div class="line">        <span class="keyword">this</span>.props = props</div><div class="line">        <span class="keyword">this</span>.key = key</div><div class="line">        <span class="keyword">this</span>.ref = ref</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createElement</span>(<span class="params">type, config, ...children</span>)｛</span></div><div class="line">    // ...</div><div class="line">    <span class="title">return</span> <span class="title">new</span> <span class="title">ReactElement</span>(<span class="params">type, props, key, ref</span>)</div><div class="line">｝</div></pre></td></tr></table></figure>
<p>然后需要导出 <code>createElement</code>，才能够通过 <code>React.createElement()</code> 的方式调用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// index.js</span></div><div class="line"><span class="keyword">import</span> &#123; createElement &#125; <span class="keyword">from</span> <span class="string">'./element'</span></div><div class="line"></div><div class="line"><span class="keyword">const</span> React = &#123;</div><div class="line">    createElement,</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> React</div></pre></td></tr></table></figure>
<p><code>ReactElement</code>需要 props, key 与 ref 参数，这三个参数将通过处理 config 与 children 得到。</p>
<p>我们将从 config 中获取 key 与 ref（若它们存在的话），并且根据 config 得到 props (去除一些不必要的属性)，同时将 children 添加到 props 当中。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createElement</span>(<span class="params">type, config, ...children</span>) </span>&#123;</div><div class="line">  <span class="keyword">let</span> props = &#123;&#125;</div><div class="line">  <span class="keyword">let</span> key = <span class="literal">null</span></div><div class="line">  <span class="keyword">let</span> ref = <span class="literal">null</span></div><div class="line"></div><div class="line">  <span class="keyword">if</span> (config != <span class="literal">null</span>) &#123;</div><div class="line">    ref = config.ref === <span class="literal">undefined</span> ? <span class="literal">null</span> : config.ref</div><div class="line">    <span class="comment">// 当 key 为数字时，将 key 转换为字符串</span></div><div class="line">    key = config.key === <span class="literal">undefined</span> ? <span class="literal">null</span> : <span class="string">''</span> + config.key</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> propsName <span class="keyword">in</span> config) &#123;</div><div class="line">      <span class="comment">// 剔除一些不需要的属性（key, ref, __self, __source）</span></div><div class="line">      <span class="keyword">if</span> (RESERVED_PROPS.hasOwnProperty(propsName)) &#123;</div><div class="line">        <span class="keyword">continue</span></div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (config.hasOwnProperty(propsName)) &#123;</div><div class="line">        props[propsName] = config[propsName]</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    props.children = children</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> ReactElement(type, props, key, ref)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>除此之外，添加对 <code>defaultProps</code> 的支持。<code>defaultProps</code> 的使用方式如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// App.js</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line">App.defaultProps = &#123;</div><div class="line">    <span class="attr">name</span>: <span class="string">"ahonn"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当传入 App 组件的 props 中不包含 name 时，设置默认的 name 为 “ahonn”。具体实现：当 ReactElement 的 type 属性为组件函数且包含 defaultProps 时遍历 props，若 props 中不包含  defaultProps 中的属性时，设置默认的 props。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createElement</span>(<span class="params">type, config, ...children</span>) </span>&#123;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">    <span class="keyword">if</span> (type &amp;&amp; type.defaultProps) &#123;</div><div class="line">        <span class="keyword">let</span> defaultProps = type.defaultProps</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> propsName <span class="keyword">in</span> defaultProps) &#123;</div><div class="line">            <span class="keyword">if</span> (props[propsName] === <span class="literal">undefined</span>) &#123;</div><div class="line">                props[propsName] = defaultProps[propsName]</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>目前为止完成了将 JSX 解析为函数调用（这部分由 babel 完成），调用 <code>React.createElement()</code> 生成 <code>ReactElement</code> 对象。</p>
<p>接下来将实现 <code>instantiateReactComponent()</code>，通过 ReactELemnt 生成相对应的 <code>ReactComponent</code> 实例。</p>
<h3 id="实现工厂方法-instantiateReactComponent"><a href="#实现工厂方法-instantiateReactComponent" class="headerlink" title="实现工厂方法 instantiateReactComponent"></a>实现工厂方法 instantiateReactComponent</h3><p><code>instantiateReactComponent(element)</code>接受一个参数 element，该参数可以是 ReactElement 对象，string，number，false 或者 null。</p>
<p>我们将只考虑 Web 端，而不像 React 一样使用适配器模式进行解耦。</p>
<p>ReactElement 生成相应 ReactComponent 实例的规则：</p>
<ul>
<li><p>element 为 null 或 false 时，生成 ReactDOMEmptyComponent 对象实例</p>
</li>
<li><p>element 为 string 或者 number 时，生成 ReactDOMTextComponent 对象实例</p>
</li>
<li><p>element 为 object</p>
<ul>
<li><p>element.type 为 string 时，生成 ReactDOMComponent 对象实例</p>
</li>
<li><p>element.type 为 function（组件函数）时，生成 ReactCompositeComponent 对象实例</p>
</li>
</ul>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// virtual-dom.js</span></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">instantiateReactComponent</span>(<span class="params">element</span>) </span>&#123;</div><div class="line">  <span class="keyword">let</span> instance = <span class="literal">null</span></div><div class="line">  <span class="keyword">if</span> (element === <span class="literal">null</span> || element === <span class="literal">false</span>) &#123;</div><div class="line">    instance = <span class="keyword">new</span> ReactDOMEmptyComponent()</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> element === <span class="string">'string'</span> || <span class="keyword">typeof</span> element === <span class="string">'number'</span>) &#123;</div><div class="line">    instance = <span class="keyword">new</span> ReactDOMTextComponent(element)</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> element === <span class="string">'object'</span>) &#123;</div><div class="line">    <span class="keyword">let</span> type = element.type</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> type === <span class="string">'string'</span>) &#123;</div><div class="line">      instance = <span class="keyword">new</span> ReactDomComponent(element)</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> type === <span class="string">'function'</span>)&#123;</div><div class="line">      instance = <span class="keyword">new</span> ReactCompositeComponent(element)</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> instance</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="实现-ReactComponent"><a href="#实现-ReactComponent" class="headerlink" title="实现 ReactComponent"></a>实现 ReactComponent</h3><p>现在，我们需要有不同的 <code>ReactComponent</code> 类以供 <code>instantiateReactComponent()</code>使用。同时需要实现每个类的 <code>mountComponent()</code> 方法来返回对应的 HTML 片段。</p>
<p><strong>ReactDOMEmptyComponent</strong></p>
<p><code>ReactDOMEmptyComponent</code> 表示空组件， <code>mountComponent()</code> 方法返回空字符串。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReactDOMEmptyComponent</span> </span>&#123;</div><div class="line">  <span class="keyword">constructor</span>() &#123;</div><div class="line">    <span class="keyword">this</span>._element = <span class="literal">null</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  mountComponent() &#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">''</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>ReactDOMTextComponent</strong></p>
<p>ReactDOMTextComponent 表示 DOM 文本组件，<code>mountComponent()</code>方法返回对应的字符串。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReactDOMTextComponent</span> </span>&#123;</div><div class="line">  <span class="keyword">constructor</span>(text) &#123;</div><div class="line">    <span class="keyword">this</span>._element = text</div><div class="line">    <span class="keyword">this</span>._stringText = <span class="string">''</span> + text</div><div class="line">    <span class="keyword">this</span>._rootID = <span class="number">0</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  mountComponent(rootID) &#123;</div><div class="line">    <span class="keyword">this</span>._rootID = rootID</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>._stringText</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>ReactDOMComponent</strong></p>
<p>ReactDOMComponent 表示原生组件，即浏览器支持的标签（div, p, h1, etc.）。<code>mountConponent()</code> 方法返回对应的 HTML 字符串。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReactDomComponent</span> </span>&#123;</div><div class="line">  <span class="keyword">constructor</span>(element) &#123;</div><div class="line">    <span class="keyword">let</span> tag = element.type</div><div class="line"></div><div class="line">    <span class="keyword">this</span>._element = element</div><div class="line">    <span class="keyword">this</span>._tag = tag.toLowerCase()</div><div class="line">    <span class="keyword">this</span>._rootID = <span class="number">0</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  mountComponent(rootID) &#123;</div><div class="line">    <span class="keyword">this</span>._rootID = rootID</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="keyword">this</span>._element.type !== <span class="string">'string'</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'DOMComponent\'s Element.type must be string'</span>)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">let</span> ret = <span class="string">`&lt;<span class="subst">$&#123;<span class="keyword">this</span>._tag&#125;</span> `</span></div><div class="line">    <span class="keyword">let</span> props = <span class="keyword">this</span>._element.props</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> propsName <span class="keyword">in</span> props) &#123;</div><div class="line">      <span class="keyword">if</span> (propsName === <span class="string">'children'</span>) &#123;</div><div class="line">        <span class="keyword">continue</span></div><div class="line">      &#125;</div><div class="line">      <span class="keyword">let</span> propsValue = props[propsName]</div><div class="line">      ret += <span class="string">`<span class="subst">$&#123;propsName&#125;</span>=<span class="subst">$&#123;propsValue&#125;</span>`</span></div><div class="line">    &#125;</div><div class="line">    ret += <span class="string">'&gt;'</span></div><div class="line"></div><div class="line">    <span class="keyword">let</span> tagContent = <span class="string">''</span></div><div class="line">    <span class="keyword">if</span> (props.children) &#123;</div><div class="line">      tagContent = <span class="keyword">this</span>._mountChildren(props.children)</div><div class="line">    &#125;</div><div class="line">    ret += tagContent</div><div class="line">    ret += <span class="string">`&lt;/<span class="subst">$&#123;<span class="keyword">this</span>._tag&#125;</span>&gt;`</span></div><div class="line">    <span class="keyword">return</span> ret</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>ReactDOMComponent</code> 的 <code>mountComponent()</code>方法会相对复杂一点。具体实现思路是，通过 <code>ReactElement</code> 的 type 与 props 属性拼接对应的 HTML 标签。处理 props 的时候需要跳过 children 属性，因为需要将子组件放在当前组件中。</p>
<p>当存在子组件（children）时，调用 <code>_mountChildren(children)</code>将组件转换为对应的 HTML 片段。具体过程是遍历 children，转换为 <code>ReactComponent</code> 并调用其 <code>mountComponent()</code> 方法。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">_mountChildren(children) &#123;</div><div class="line">  <span class="keyword">let</span> result = <span class="string">''</span></div><div class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> index <span class="keyword">in</span> children) &#123;</div><div class="line">    <span class="keyword">const</span> child = children[index]</div><div class="line">    <span class="keyword">const</span> childrenComponent = instantiateReactComponent(child)</div><div class="line">    result += childrenComponent.mountComponent(index)</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> result</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>ReactCompositeComponent</strong></p>
<p>ReactCompositeComponent 表示自定义的组件，<code>mountComponent()</code>方法将根据提供的组件函数（element.type）实例化，并调用该组件的 <code>render()</code>方法返回 <code>ReactElement</code> 对象。再通过<code>instantiateReactComponent()</code> 生成对应的 <code>ReactComponent</code>，最后执行该 <code>ReactComponent</code> 的<code>mountComponent()</code>方法。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReactCompositeComponent</span> </span>&#123;</div><div class="line">  <span class="keyword">constructor</span>(element) &#123;</div><div class="line">    <span class="keyword">this</span>._element = element</div><div class="line">    <span class="keyword">this</span>._rootId = <span class="number">0</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  mountComponent(rootID) &#123;</div><div class="line">    <span class="keyword">this</span>._rootId = rootID</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="keyword">this</span>._element.type !== <span class="string">'function'</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'CompositeComponent\'s Element.type must be function'</span>)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> Component = <span class="keyword">this</span>._element.type</div><div class="line">    <span class="keyword">const</span> props = <span class="keyword">this</span>._element.props</div><div class="line">    <span class="keyword">const</span> instance = <span class="keyword">new</span> Component(props)</div><div class="line"></div><div class="line">    <span class="keyword">const</span> renderedElement = instance.render()</div><div class="line">    <span class="keyword">const</span> renderedComponent = instantiateReactComponent(renderedElement)</div><div class="line">    <span class="keyword">const</span> renderedResult = renderedComponent.mountComponent(rootID)</div><div class="line">    <span class="keyword">return</span> renderedResult</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过 ReactCompositeComponent 将之前的 ReactComponent 联系起来，并递归调用 <code>mountComponent</code>方法得到一段 HTML。最后 <code>render()</code>通过 node.innerHTML 将 HTML 字符串填到页面上对应的容器中。</p>
<h3 id="实现-render"><a href="#实现-render" class="headerlink" title="实现 render"></a>实现 render</h3><p>最后将之前的实现串起来，利用 innerHTML 将组件渲染到页面上。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">element, container</span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> rootID = <span class="number">0</span></div><div class="line">  <span class="keyword">const</span> mainComponent = instantiateReactComponent(element)</div><div class="line">  <span class="keyword">const</span> containerContent = mainComponent.mountComponent(rootID)</div><div class="line"></div><div class="line">  container.innerHTML = containerContent</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>到这里就基本上简单的实现了 React 中将组件渲染到页面上的部分。可以通过一个简单的例子验证一下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// index.js</span></div><div class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'./tiny-react'</span></div><div class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'./tiny-react'</span></div><div class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./App'</span></div><div class="line"></div><div class="line">ReactDOM.render(<span class="xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span>, document.getElementById('root'))</span></div><div class="line"></div><div class="line">// App.js</div><div class="line"></div><div class="line">import React, &#123; Component &#125; from './tiny-react'</div><div class="line"></div><div class="line">class App extends Component &#123;</div><div class="line">  render() &#123;</div><div class="line">    return (</div><div class="line">      <span class="tag">&lt;<span class="name">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">span</span>&gt;</span>It is Work!<span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    )</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">export default App</div></pre></td></tr></table></figure>
<p>页面上将显示 It is Work!</p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>虽然没有涉及到组件更新与组件生命周期，通过阅读 React 的源码基本上也对初始化渲染的过程有了一定的了解，希望对你有所帮助。</p>
<p>在此感谢 <a href="https://github.com/developit/preact" target="_blank" rel="noopener">preact</a>, <a href="https://github.com/Lucifier129/react-lite" target="_blank" rel="noopener">react-lite</a>, <a href="https://github.com/CodeFalling/react-tiny" target="_blank" rel="noopener">react-tiny</a> 等项目，它们为本文提供了很大帮助。</p>
<p>文中的所有代码均于 <a href="https://github.com/ahonn/tiny-react/tree/init-render" target="_blank" rel="noopener">tiny-react init-render</a> ，感谢阅读。</p>

      
    </div>

    
      
      

  <div class="post-copyright">
    <p class="copyright-item">
      <span>原文作者: </span>
      <a href="http://www.ahonn.me">Ahonn</a>
    </p>
    <p class="copyright-item">
      <span>原文链接: </span>
      <a href="http://www.ahonn.me/2017/06/08/write-a-react-from-scratch-init-render/">http://www.ahonn.me/2017/06/08/write-a-react-from-scratch-init-render/</a>
    </p>
    <p class="copyright-item">
      <span>许可协议: </span>
      
      <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>
    </p>
  </div>



      
      
    

    
      <footer class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/React/">React</a>
            
              <a href="/tags/从零开始/">从零开始</a>
            
          </div>
        
        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2017/06/23/arrived-in-hangzhou/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">到达杭州</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    
    
      <a class="next" href="/2017/05/17/koa2-analysis/">
        <span class="next-text nav-default">Koa2 源码分析</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

      </footer>
    

  </article>


          </div>
          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:ahonn95@outlook.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/ahonn" class="iconfont icon-github" title="github"></a>
        
      
    
      
    
      
        
          <a href="https://www.zhihu.com/people/ahonn/activities" class="iconfont icon-zhihu" title="zhihu"></a>
        
      
    
      
    
      
    
      
    
      
    
    
    
      <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    
  </div>


<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2015 - 
    
    2018

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Ahonn</span>
  </span>
</div>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  
  <script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'http://www.ahonn.me/2017/06/08/write-a-react-from-scratch-init-render/';
        this.page.identifier = '2017/06/08/write-a-react-from-scratch-init-render/';
        this.page.title = '从零开始写一个 React：初始化渲染';
    };
    (function() {
    var d = document, s = d.createElement('script');

    s.src = '//ahonn.disqus.com/embed.js';

    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();  
  </script>




    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  


    <script type="text/javascript" src="/js/src/even.js?v=2.6.0"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=2.6.0"></script>

  </body>
</html>
